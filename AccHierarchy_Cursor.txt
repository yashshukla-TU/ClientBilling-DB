select A.Project_Id,RPT.POSITION,CASE   
				   WHEN RPT.[position] IN ('Teammate', 'Teammate (Subject Matter Expert)') THEN 'Billable-Production'  
				   WHEN RPT.[position] IN ('Learning Experience Leader', 'Quality Analyst', 'Team Leader') THEN 'Billable-Support'  
				   ELSE 'NonBillable'  
				  END [Billablecategory] INTO #Proj_Position from DimProject as a --DROP TABLE #PROJ_POSITION
join v_utl_teleopti_billing_last_3_months as rpt on a.Project_Id  = TRIM(REVERSE(SUBSTRING(REVERSE(RPT.project_id), CHARINDEX('-', REVERSE(RPT.project_id))+1, LEN(RPT.project_id))))
group by A.Project_Id,RPT.POSITION
ORDER BY A.Project_Id

SELECT * FROM #Proj_Position


select A.Project_Id,C.Site_NewName INTO #Proj_Site from DimProject as a 
join RPT_BILLING as rpt on a.Project_Id  = TRIM(REVERSE(SUBSTRING(REVERSE(RPT.[ProjectID]), CHARINDEX('-', REVERSE(RPT.[ProjectID]))+1, LEN(RPT.[ProjectID]))))
JOIN DimSite AS C ON C.Site_NewName = RPT.[Site]
group by A.Project_Id,C.Site_NewName
ORDER BY A.Project_Id
--DROP TABLE #PROJ_SITE

SELECT DP.Project_Id,Hierarchy.HierarchyCode,Concat(ISNULL(Hierarchy.[Line Of Business],''),' | ',ISNULL([Sub Line of Business],''),' | ',ISNULL([Process],''),' | ',ISNULL([Sub Process],''),' | ',ISNULL([Channel],''),' | ',ISNULL([Language],'')) [Account Hierarchy]
INTO #PROJ_Hierarchy
FROM Dim_AccountHierarchy AS Hierarchy
JOIN DimProject AS dp on TRIM(REVERSE(SUBSTRING(REVERSE(Hierarchy.[ProjectCode]), CHARINDEX('-', REVERSE(Hierarchy.[ProjectCode]))+1, LEN(Hierarchy.[ProjectCode])))) = DP.Project_Id AND DP.IsActive = 1




SELECT * FROM #Proj_Position AS A
CROSS JOIN (SELECT * FROM #Proj_Site WHERE Project_Id = '23300-01-01') AS B
CROSS JOIN (SELECT * FROM #PROJ_Hierarchy where Project_Id = '23300-01-01') AS C
WHERE A.Project_Id = '23300-01-01'

SELECT	CAST(NULL AS VARCHAR(250)) [CLient],
	CAST(NULL AS VARCHAR(30)) [ProjectID],
	CAST(NULL AS VARCHAR(220)) [Position],
	CAST(NULL AS VARCHAR(100)) [HierarchyCode],
	CAST(NULL AS VARCHAR(300)) [AccountHierarchy],
	CAST(NULL AS VARCHAR(50)) [Billable Category],
	CAST(NULL AS VARCHAR(225)) [Delivery site]
	INTO #PricingTable --DROP TABLE #PRICINGTABLE

	--select * from #pricingTable
DECLARE @ProjID VARCHAR(225);
DECLARE HierarchyCodeCombo CURSOR 
FOR SELECT PROJECT_ID FROM DimProject WHERE IsActive = 1 AND Client <> 'Albertsons'

OPEN HierarchyCodeCombo;
FETCH NEXT FROM HierarchyCodeCombo
INTO @ProjID;

WHILE @@FETCH_STATUS =0
	BEGIN
		INSERT INTO #PricingTable
				
		SELECT AA.Client,AA.Project_Id,A.position,C.HierarchyCode,C.[Account Hierarchy],A.Billablecategory,B.Site_NewName FROM #Proj_Position AS A
		JOIN DimProject AS AA ON A.Project_Id = AA.Project_Id
		CROSS JOIN (SELECT * FROM #Proj_Site WHERE Project_Id = @ProjID) AS B
		CROSS JOIN (SELECT * FROM #PROJ_Hierarchy where Project_Id = @ProjID) AS C
		WHERE A.Project_Id = @ProjID

				FETCH NEXT FROM HierarchyCodeCombo INTO @ProjID;
	END

CLOSE HierarchyCodeCombo;

DEALLOCATE HierarchyCodeCombo;


SELECT ProjectID,COUNT(*) FROM #PricingTable
GROUP BY ProjectID




SELECT * FROM #PricingTable


SELECT COUNT(*) FROM #Proj_Position 
WHERE Project_Id = '48000-01-01'

SELECT COUNT(*) FROM #PROJ_Hierarchy 
WHERE Project_Id = '48000-01-01'

SELECT COUNT(*) FROM #Proj_Site 
WHERE Project_Id = '48000-01-01'

SELECT * FROM #PricingTable
WHERE ProjectID = '48000-01-01'

SELECT * FROM DimProject










